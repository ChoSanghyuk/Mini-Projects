# 투자 포트폴리어 관리 서버



## 개요

사전에 정한 규칙에 맞추어 자산을 관리할 수 있도록 도와주는 프로젝트입니다. 자금의 종류를 나누어, 자금별로 독립적으로 관리될 수 있도록 합니다. 시장 상황과 종목 가격에 따라 매수/매도 규칙을 정하고, 규칙이 부합되었을 때 이행 할 수 있도록 보조하는 역할을 수행합니다. 이를 위해서 프로젝트는 크게 3가지 작업을 수행합니다. 

1. 투자 기준이 되는 정보 저장 
2. 관심 종목을 지속적으로 확인하여, 투자 행동별 기준에 부합되었을 때 알림 전송 
3. 현재의 자산 및 투자 이력 관리



**투자 기준 정보 저장**

우선, 종목의 매수/매도 수행의 기준이 되는 정보를 저장합니다. 기준이 되는 정보는 1.시장 상황 2. 종목 정보입니다.

시장 상황은 총 5단계로, 큰 하락 예상, 하락 예상, 변동 구간, 상승 예상, 큰 상승 예상으로 구분합니다. 각 단계별 변동 자산 비중은 다음과 같이 유지됩니다.

| 단계          | 1            | 2         | 3         | 4         | 5    |
| ------------- | ------------ | --------- | --------- | --------- | ---- |
| **시장 예측** | 큰 하락 | 하락 | 변동 | 상승 | 큰 상승 |
| 변동 자산 비중 | 30% | 40% | 50% | 60% | 70% |

시장의 단계는 직접 저장합니다. 다만, 시장 단계 파악에 도움이 되는 공포탐욕지수, CLI Index 정보를 매일 갱신해두어, 조회할 수 있도록 합니다.



종목 정보는 투자 대상으로 보고 있는 종목의 정보로, 이름, 구분, 통화, 고점, 저점, 기준 매도가, 기준 매수가를 가집니다. 이때, 기준 매도가와 기준 매수가는 optional한 정보입니다.

종목 구분은 다음의 카테고리로 관리합니다. 이중 4단계 이후를 변동 자산으로 취급합니다.

| 카테고리 | 1    | 2    | 3    | 4        | 5    | 6    | 7     | 8        |
| -------- | ---- | ---- | ---- | -------- | ---- | ---- | ----- | -------- |
| 의미     | 현금 | 달러 | 금   | 단기채권 | ETF  | 주식 | 코인  | 레버리지 |
| 심볼     | KRW  | USD  | GLD  | STB      | ETF  | STK  | CRYTO | XETF     |





**투자 행동 알림**

투자한 종목들에 대해 현재가를 주기적으로 확인하고 투자 행동 기준에 충족되는지 확인합니다.



우선, 시장 상황에 따라 자금별 변동 자산 비중 관리 알람을 전송합니다. 

특정 자금이 현재 시장 단계의 변동 자산 비중을 초과한 경우, 해당 자금의 매도 알림이 갑니다. 알림에는 해당 자금의 포트폴리오와 우선 처분 대상 목록을 전송합니다. 현재 시장 단계의 변동 자산 비중보다 낮게 비중을 유지하는 경우에는 별도의 알림이 가지 않습니다.



또한, 종목의 기준 가격에 따라 중목 매도/매수 관리 알람을 전송합니다. 

기준 매도가가 있을 경우, 종목의 현재가가 기준 매도가보다 높아질 때 매도 알람을 전송합니다. 기준 매도가가 없을 경우, 매도 미대상으로 분류합니다. 다만, 변동 자산 비중이 넘어 갔을 경우, 고점보다 현재가가 높은 자산이 우선 처분 대상이 됩니다. 

기준 매수가가 있을 경우, 종목의 현재가가 기준 매수가보다 낮아질 때 매수 알림을 전송합니다. 또한, 10%씩 추가 하락시 매수 알림을 전송합니다. 기준 매수가가 없을 경우, 저점이 기준 매수가가 됩니다.



**현재의 자산 및 투자 이력 관리**

현재 자산 정보를 조회하고, 투자 이력 정보를 저장합니다. 

행동 알림에 따라 매수/매도를 수행한 경우, 수행한 이력을 저장합니다. 저장된 이력은 현재 자산 정보, 투자 행동 알림의 보유 종목, 변동 종목 비중 등에 사용됩니다. 



## 설계

### 작업별 요구사항

#### 투자 기준 정보 저장

- [x] 현재 시장 단계 저장
  - [x] 현재 시장 단계 저장 API (입력: 현재 단계)
    - 입력으로 온 현재 단계 값이 1~5의 정수인지 검증
  - [ ] 시장 상태 조회 API (출력 : 현재 단계, 변동 자산 비중, 공포탐욕지수, CLI Index, CLI Index 연속 상승/하락 정보, 나스닥 연속 상승/하락 정보)

- [x] 종목 정보 저장
  - [x] 종목 정보 저장/갱신 API (입력 : 이름, 구분, 통화, 기준 매도가, 기준 매수가 )
    - 입력으로 온 구분 값이 카테고리 값인지 검증
    - 고점, 저점은 자체 크롤링으로 정보 조회하여 저장
    - 기준 매수가 미존재 시, 저점값 사용
  - [x] 종목 정보 개별 조회
  - [x] 종목 리스트 조회 (통화, 투자된 총액 같이 조회)
  - [x] 종목 정보 삭제


#### 투자 행동 알림

- [x] 보유하고 있는 종목에 대한 현재가 크롤링
  - [x] :heavy_exclamation_mark: 종목 정보를 가지고 동적으로 현재가 정보를 가져올 수 있는 기능 필요 (가능한 사이트 사전 탐색)
    - 주식/ETF => 한국투자증권 API
    - 코인 => upbit API
- [x] 갱신된 현재가로 현재 시장 상태의 변동 자산 비중을 초과했는지 여부 확인
- [x] 초과 시 알림 전송 (전송 정보 : 시장 상태, 최대 변동 자산 비중, 자금 ID, 자금의 현재 변동 자산 비중, 자금 포트폴리오, 우선 처분 대상 종목)
- [x] 갱신된 현재가로 매도/매수 기준 충족 여부 확인 (매수/매도 기준가에서 10%씩 더 벗어날때마다 알림)
- [x] 충족 시 알림 전송 (전송 정보 : 종목 이름, 종목 구분, 통화, 고점, 저점, 기준 매도가, 기준 매수가, 현재가)
  - [ ] (추가) 자금별 사용 가능 금액
  - [ ] 한번 알림 후 n% 변동 이후에야 다시 알림 전송. 
- [ ] 매일 시장 상태 관련 정보 알림 전송


#### 현재의 자산 및 투자 이력 관리

- [ ] 현재 자산 정보를 조회
  - [x] 1.전체 자금 총액 2.자금 종목현황 3.자금 투자이력
  - [x] 1.전체 종목 총액 2.종목 총액 3.종목 투자이력 4.종목 정보 정보투자기준 관리
- [x] 투자 이력 저장 (입력 : 자금Id, 종목 Id, 현재가, 개수)
  - [x] 현금 충전


#### 공통

- [x] 자금을 n개 영역으로 나누어 관리
  - ex) 3분할 : 공통자금, 퇴직자금, 개인투자자금
- [ ] 로그인, API KEY 정보는 암호화해서 DB 저장. 서버에서 복호화해서 사용



### 패키지 설계

- app
  - 개요
    - 사용자 요청을 처리하는 서버
    - API 담당
  - 기능
    - 자산 현황 조회
    - 투자 이력 저장
    - 종목 정보 저장
    - 현재 시장 단계 저장

- event

  - 개요
    - 시장 단계, 종목 정보, 종목 현재가를 조합하여, 투자 행동 알림 전송
  - 기능
    - 변동 자산 비중 초과 알림
    - 매도/매수 알림
    - 우선 처분 대상 판단

- util

  - scrape
    - 개요
      - 인터넷 크롤링, API 호출을 통해서 현재가와 같이 변하는 정보 수집
    - 기능
      - 크롤링 : url, css path 입력받아 타겟 정보 반환
      - API 호출 : url, header 입력받아 api 호출 결과 반환

  - alarm
    - 개요
      - 알림 메시지를 전달받아, 지정한 방식으로 알림 전송
    - 기능
      - 알림 방식 지정
      - 알림 전송

- db

  - 개요
    - database 저장, 갱신, 조회, 삭제 담당
  - 기능
    - app, event에서 사용할 자금, 종목, 시장 정보들에 대한 CRUD

- model
  - 개요
    - 패키지들에서 공통적으로 사용할 타입/변수 정의

- config
  - 개요
    - 설정 값 정의



### API 설계

- 자금 (`/funds`)
  - 전체 현황 조회 (`GET` : `/` )
  - 신규 자금 추가 (`POST` : `/`)
  - 자금 투자 이력 (`GET` : `/:id/hist`)
  - 자금 종목별 총액 조회 (`GET` : `/:id/assets)`
- 종목 (`/assets`)
  - 종목 정보 저장 (`POST` : `/`)
  - 종목 정보 갱신 (`POST` : `/:id`)
  - 종목 정보 삭제 (`DELETE` : `/:id`)
  - 종목 정보 조회 (`GET` : `/:id`)
  - 종목 목록 조회 (`GET` : `/list`)
  - 중목 투자 이력 조회  (`GET` : `/:id/hist`)
- 시장상태 (`/market`)
  - 시장 단계 저장 (`POST` : `/`)
  - 시장 상태 조회 (`GET` : `/` )

- 투자(`/invest`)
  - 내역 저장 (`POST` : `/`)



### 모델링

![image-20240906160601407](img/image-20240906160601407.png)







event

1.. 대상들을 읽어서  <= DB

2.. 해당 대상의 가격 정보를 어디서 조회할지 가져옴 <= config

3.. 크롤링 수행 <= scrape

4.. 알람 대상인지 확인 <= 자체

5.. 대상 시, 알람. <= channel



1.. 








The root by default listens only to localhost connections. need to create a new user, who can listen to all IP connections.
create user if not exists `duck`@`%`
 % wildcard indicates that the duck user should listen to all IPs.

Your default MySQL config only accepts connections from 127.0.0.1 and not from any other IP address. To resolve this, we must update the config to allow binding (accepting) connections from all IP addresses. You can set specific IP addresses, but WSL’s IP addresses vary, so this is an easier alternative.
Update the bind-address property from 127.0.0.1 to 0.0.0.0 in the MySQL Config file located at /etc/mysql/mysql.conf.d/mysqld.cnf and restart the MySQL server


## DB 설정

```sh
$ docker run -v /invest/db:/var/lib/mysql --name investDb -e MYSQL_ROOT_PASSWORD=root -d -p 3306:3306 mysql 
```


## Mock 설정
```sh
go install github.com/vektra/mockery/v2@v2.44.1
go generate ./...
```

//go:generate mockery --name {interface name} --case underscore --inpackage

mockery는  mock의 메소드별 행동을 명시적으로 정의해야 함.
모든 메소드에 대해서 행동을 지정하기 위해서는 reflect를 사용하여 모든 메소드들을 loop 돌면서 지정 가능
```go
ref := reflect.TypeOf(MyInterface)
for i :=0; i < ref.NumMethod(); i++{
    method := ref.Method(i)
    mockObj.On(method.Name).Return(nil)
}

```